<div class="modal fade" id="book-edit-modal" tabindex="-1" aria-labelledby="myModalLabel" style="display: none;" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <h4 class="modal-title text-center" id="H1"><%= t('update_book')%></h4>
        <button class="close close-L" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>

        <div class="mt-3">
          <%= nested_form_for @book, url: book_path, method: :put do |f| %>
          <div class="form-group row">
            <label for="example-text-input" class="col-md-2 col-form-label"><%= t('book_title') %></label>
            <div class="col-md-10">
              <%= f.text_field :title, class: "form-control text-center",placeholder: t('book_title') %>
            </div>
          </div>

          <div class="form-group row">
            <label for="example-text-input" class="col-md-2 col-form-label"><%= t('author_name') %></label>
            <div class="col-md-10">
              <%= f.text_field :author_name, class:"form-control text-center", placeholder: t('author_name') %>
              <%#= f.select :user_id, options_for_select(User.all.pluck(:full_name, :id)), { include_blank: true},class: "custom-select custom-select-sm" %>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-md-2 col-form-label pr-0"><%= t('book_duration') %></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12">
                  <%= f.text_field :book_duration, class: "form-control text-center update-book-duration", placeholder: t('book_duration'), disabled: true %>
                </div>
              </div>
            </div>

            <label class="col-md-2 col-form-label"><%= t('category') %></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12" data-controller="select2">
                  <%= f.select :category_ids, options_for_select(Category.all.pluck(:name, :id), selected: book&.categories&.pluck(:id)), { include_blank: true},{multiple: true, id: "update-category-dropdown", style: "width: 33.75em;"} %>
                </div>
              </div>
            </div>

          </div>

          <div class="form-group row">
            <label for="example-text-input" class="col-md-2 col-form-label"><%= t('about_the_book') %></label>
            <div class="col-md-10">
              <%= f.text_area :body, class: "form-control text-center", placeholder: t('about_the_book') %>
            </div>
          </div>

          <h4 class="modal-title text-center mb-4" id="H1"><%= t('audio_book_files') %></h4>
          <%= f.fields_for :book_files do |bk| %>
          <div class="form-group row">
            <label class="col-md-2 col-form-label pr-0"><%= t('book_cover') %></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <% if false %>
                    <input type="file" name="img[]" class="file">
                    <div class="input-group mb-3">
                      <div class="input-group-append">
                        <a class="browse input-group-text btn btn-default bg-white file-bor-rad bor-R" id="basic-addon2"><i class="fas fa-paperclip"></i></a>
                      </div>
                      <%= bk.file_field :book_cover_file, class: "form-control bg-white", placeholder: "upload file" %>
                      <!-- <input type="text" class="form-control bg-white" disabled placeholder="Upload File" aria-label="Upload File" aria-describedby="basic-addon1"> -->
                    </div>
                    <% end %>
                    <%= bk.file_field :book_cover_file,id: "update-book-cover-field", class: "mb-1", placeholder: "upload file" %>
                    <% bf = book.book_files.first if book.book_files.present? %>
                    <% src = nil %>
                    <% if bf.book_cover_file.present? %>
                      <% src = rails_blob_path(bf.book_cover_file , only_path: true) %>
                    <% end %>
                    <div class="update-upload-preview" style="margin-top: 10px;">
                      <img style="width: 50%; height: 50%;" src=<%= src %>/>
                    </div>
                    <!-- <div class="upload-preview" style="margin-top: 10px;">
                      <img style="width: 50%; height: 50%;"/>
                    </div> -->
                  </div>
                </div>
              </div>
            </div>

            <label class="col-md-2 col-form-label"><%= t("audio_file") %></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <% if false %>
                    <input type="file" name="img[]" class="file">
                    <div class="input-group mb-3">
                      <div class="input-group-append">
                        <a class="browse input-group-text btn btn-default bg-white file-bor-rad bor-R" id="A1"><i class="fas fa-paperclip"></i></a>
                      </div>
                      <%= bk.file_field :audio, class: "form-control bg-white", placeholder: "upload file" %>
                      <!-- <input type="text" class="form-control bg-white" disabled placeholder="Upload File" aria-label="Upload File" aria-describedby="basic-addon1"> -->
                    </div>
                    <% end %>
                    <%= bk.file_field :audio, class: "mb-2", placeholder: "upload file", id: "update-book-audio-field"%>
                    <% audio_src = nil %>
                    <% if bf.audio.present? %>
                      <% audio_src = rails_blob_path(bf.audio, only_path: true) %>
                    <% end %>
                    <div class="update-upload-audio-preview" style="margin-top: 10px;">
                      <audio  controls="controls" src="<%= audio_src %>" id="update_long_audio"></audio>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="form-group row">
            <label class="col-md-2 col-form-label"></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12 text-center">
                  <%= button_tag( :class => "btn btn-labeled btn-secondary-blue btn-rdius btn-rdius-13 font-bold") do %>
                    <%= t('update') %> <span class='btn-label btn-label-right'><i class='fa fa-plus'></i></span>
                  <% end %>
                </div>
              </div>
            </div>
            <label class="col-md-2 col-form-label"><%= t("short_audio") %></label>
            <div class="col-md-4">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <% if false %>
                    <input type="file" name="img[]" class="file">
                    <div class="input-group mb-3">
                      <div class="input-group-append">
                          <a class="browse input-group-text btn btn-default bg-white file-bor-rad bor-R" id="A3"><i class="fas fa-paperclip"></i></a>
                      </div>
                      <%= bk.file_field :short_audio_file, class: "form-control bg-white", placeholder: "upload file" %>
                      <!-- <input type="text" class="form-control bg-white" disabled placeholder="Upload File" aria-label="Upload File" aria-describedby="basic-addon1"> -->
                    </div>
                    <% end %>
                    <%= bk.file_field :short_audio_file, class: "mb-2", placeholder: "upload file", id: "update-book-short-audio-field" %>
                    <% short_audio_src = nil %>
                    <% if bf.short_audio_file.present? %>
                      <% short_audio_src = rails_blob_path(bf.short_audio_file, only_path: true) %>
                    <% end %>
                    <div class="update-upload-short-audio-preview" style="margin-top: 10px;">
                      <audio  controls="controls" id="update_short_audio"></audio>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <% end %>
          <% end %>
        </div>
      </div>

    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    $("#update-category-dropdown").select2();

    var preview = $(".update-upload-preview img");
    var audio_preview = $(".update-upload-audio-preview audio")
    var short_audio_preview = $(".update-upload-short-audio-preview audio")


    $("#update-book-cover-field").change(function(event){
       var input = $(event.currentTarget);
       var file = input[0].files[0];
       var reader = new FileReader();
       reader.onload = function(e){
           image_base64 = e.target.result;
           preview.attr("src", image_base64);
       };
       reader.readAsDataURL(file);
    });

    $("#update-book-audio-field").change(function(event){
      var audio_input = $(event.currentTarget);
      var file = audio_input[0].files[0]
      var reader = new FileReader();
      reader.onload = function(e){
        audio_base64 = e.target.result;
        audio_preview.attr("src", audio_base64);
      };
      reader.readAsDataURL(file);
      setTimeout(function() {
        // duration in second
        var duration = $("#update_long_audio")[0].duration;
        var duration_in_min = duration / 60
        $(".update-book-duration").val(parseFloat(duration_in_min.toFixed(2)));
      }, 2000);
    });

    $("#update-book-short-audio-field").change(function(event){
      var audio_input = $(event.currentTarget);
      var file = audio_input[0].files[0]
      var reader = new FileReader();
      reader.onload = function(e){
        audio_base64 = e.target.result;
        short_audio_preview.attr("src", audio_base64);
      };
      reader.readAsDataURL(file);
    });
  });

</script>